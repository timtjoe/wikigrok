name: Deploy and Release

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "master-deploy"
  cancel-in-progress: true

jobs:
  deploy-web:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2

      - name: Check for Web changes
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            web:
              - './*'          
              - 'src/**'
              - 'public/**'
              - 'index.html'

      - name: Build and Deploy Frontend
        if: steps.filter.outputs.web == 'true'
        run: |
          bun install
          
          # 1. Build the JS bundle
          # This creates dist/frontend.js (and css)
          bun build ./src/frontend.tsx --outdir ./dist --minify --public-path /wikigrok/
          
          # 2. Copy the HTML file to dist
          cp src/index.html dist/index.html
          
          # 3. FIX: Update the script tag in the HTML
          # Change src="./frontend.tsx" to src="/wikigrok/frontend.js"
          sed -i 's|src="./frontend.tsx"|src="/wikigrok/frontend.js"|g' dist/index.html
          
          # 4. Create 404.html for React Router deep-linking support
          cp dist/index.html dist/404.html

      - name: Upload to GH Pages
        if: steps.filter.outputs.web == 'true'
        uses: actions/upload-pages-artifact@v3
        with:
          path: "./dist"

      - name: Deploy
        if: steps.filter.outputs.web == 'true'
        uses: actions/deploy-pages@v4